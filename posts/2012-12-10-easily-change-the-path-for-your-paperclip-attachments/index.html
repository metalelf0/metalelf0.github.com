<!doctype html><html lang=en><head><title>Easily change the path for your Paperclip attachments · metalelf0.github.io
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="metalelf0"><meta name=description content="Today after releasing an app to production environment I saw a couple of paperclip warnings like this in my production.log file:
[paperclip] Duplicate URL for round_image with 
/system/:attachment/:id/:style/:filename. This
will clash with attachment defined in
PageElements::FranchisingCarouselEntry class
This happens because I defined an attachment with the same name in two different models, and the default strategy Paperclip uses to choose attachment locations could lead to filename clashing.
Here is a more detailed example:"><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Easily change the path for your Paperclip attachments"><meta name=twitter:description content="Today after releasing an app to production environment I saw a couple of paperclip warnings like this in my production.log file:
[paperclip] Duplicate URL for round_image with /system/:attachment/:id/:style/:filename. This will clash with attachment defined in PageElements::FranchisingCarouselEntry class This happens because I defined an attachment with the same name in two different models, and the default strategy Paperclip uses to choose attachment locations could lead to filename clashing.
Here is a more detailed example:"><meta property="og:url" content="https://metalelf0.github.io/posts/2012-12-10-easily-change-the-path-for-your-paperclip-attachments/"><meta property="og:site_name" content="metalelf0.github.io"><meta property="og:title" content="Easily change the path for your Paperclip attachments"><meta property="og:description" content="Today after releasing an app to production environment I saw a couple of paperclip warnings like this in my production.log file:
[paperclip] Duplicate URL for round_image with /system/:attachment/:id/:style/:filename. This will clash with attachment defined in PageElements::FranchisingCarouselEntry class This happens because I defined an attachment with the same name in two different models, and the default strategy Paperclip uses to choose attachment locations could lead to filename clashing.
Here is a more detailed example:"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2012-12-10T00:00:00+00:00"><meta property="article:modified_time" content="2012-12-10T00:00:00+00:00"><meta property="article:tag" content="Rails"><meta property="article:tag" content="Ruby"><meta property="article:tag" content="Paperclip"><link rel=canonical href=https://metalelf0.github.io/posts/2012-12-10-easily-change-the-path-for-your-paperclip-attachments/><link rel=preload href=/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.aa5ef26fa979d6793724ae2dbd71efa94fd16cb1c5c7db3b6651f21f9892a5fd.css integrity="sha256-ql7yb6l51nk3JK4tvXHvqU/RbLHFx9s7ZlHyH5iSpf0=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=/img/favicon.svg sizes=any><link rel=icon type=image/png href=/img/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/img/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://metalelf0.github.io/>metalelf0.github.io
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=/about/>About</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://metalelf0.github.io/posts/2012-12-10-easily-change-the-path-for-your-paperclip-attachments/>Easily change the path for your Paperclip attachments</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa-solid fa-calendar" aria-hidden=true></i>
<time datetime=2012-12-10T00:00:00Z>December 10, 2012
</time></span><span class=reading-time><i class="fa-solid fa-clock" aria-hidden=true></i>
2-minute read</span></div><div class=categories><i class="fa-solid fa-folder" aria-hidden=true></i>
<a href=/categories/rails/>Rails</a></div><div class=tags><i class="fa-solid fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/rails/>Rails</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/ruby/>Ruby</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/paperclip/>Paperclip</a></span></div></div></header><div class=post-content><p>Today after releasing an app to production environment I saw a couple of <a href=https://github.com/thoughtbot/paperclip class=external-link target=_blank rel=noopener>paperclip</a> warnings like this in my production.log file:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>[paperclip] Duplicate URL for round_image with 
</span></span><span class=line><span class=cl>/system/:attachment/:id/:style/:filename. This
</span></span><span class=line><span class=cl>will clash with attachment defined in
</span></span><span class=line><span class=cl>PageElements::FranchisingCarouselEntry class
</span></span></code></pre></div><p>This happens because I defined an attachment with the same name in two different models, and the default strategy Paperclip uses to choose attachment locations could lead to filename clashing.</p><p>Here is a more detailed example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=k>class</span> <span class=nc>Foo</span>
</span></span><span class=line><span class=cl>  <span class=n>has_attached_file</span> <span class=ss>:image</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Bar</span>
</span></span><span class=line><span class=cl>  <span class=n>has_attached_file</span> <span class=ss>:image</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><p>The default strategy Paperclip uses to store attachments relies on this path: <code>/system/:attachment/:id/:style/:filename</code>.</p><p>So, considering our example, if we uploaded two files called <code>image.png</code> for the first <code>Foo</code> instance and the first <code>Bar</code> instance, they would have the same path, <code>/system/image/1/original/image.png</code>.</p><p>The solution is quite easy; if we add the following line to our <code>config/environment.rb</code> file, Paperclip will add an extra directory level to separate files across different models:</p><pre><code>Paperclip::Attachment.default_options[:url] = &quot;/system/:class/:attachment/:id/:style/:filename&quot;
</code></pre><p>From now on Paperclip will search for files in the <code>system/foo/image/1/original/image.png</code> and <code>system/bar/image/1/original/image.png</code> locations. But we still need to move our previously uploaded files to the new path. We can do this with this rake task:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=n>desc</span> <span class=s2>&#34;Copy paperclip data&#34;</span>
</span></span><span class=line><span class=cl><span class=n>task</span> <span class=ss>:copy_paperclip_data</span> <span class=o>=&gt;</span> <span class=ss>:environment</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>def</span> <span class=nf>move_images</span> <span class=n>klass</span><span class=p>,</span> <span class=n>attachment_name</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span> <span class=s2>&#34;Moving </span><span class=si>#{</span><span class=n>attachment_name</span><span class=o>.</span><span class=n>pluralize</span><span class=si>}</span><span class=s2> for </span><span class=si>#{</span><span class=n>klass</span><span class=si>}</span><span class=s2>: &#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>instances</span> <span class=o>=</span> <span class=n>klass</span><span class=o>.</span><span class=n>find</span> <span class=ss>:all</span>
</span></span><span class=line><span class=cl>    <span class=n>instances</span><span class=o>.</span><span class=n>each</span> <span class=k>do</span> <span class=o>|</span><span class=n>instance</span><span class=o>|</span>
</span></span><span class=line><span class=cl>      <span class=n>file_name_method</span> <span class=o>=</span> <span class=n>attachment_name</span> <span class=o>+</span> <span class=s2>&#34;_file_name&#34;</span>
</span></span><span class=line><span class=cl>      <span class=k>unless</span> <span class=n>instance</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>file_name_method</span><span class=p>)</span><span class=o>.</span><span class=n>blank?</span>
</span></span><span class=line><span class=cl>        <span class=n>filename</span> <span class=o>=</span> <span class=no>Rails</span><span class=o>.</span><span class=n>root</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=s1>&#39;public&#39;</span><span class=p>,</span> <span class=s1>&#39;system&#39;</span><span class=p>,</span> <span class=n>attachment_name</span><span class=o>.</span><span class=n>pluralize</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>          <span class=n>instance</span><span class=o>.</span><span class=n>id</span><span class=o>.</span><span class=n>to_s</span><span class=p>,</span> <span class=s1>&#39;original&#39;</span><span class=p>,</span> <span class=n>instance</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>file_name_method</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=no>File</span><span class=o>.</span><span class=n>exists?</span> <span class=n>filename</span>
</span></span><span class=line><span class=cl>          <span class=n>old_attachment_file</span> <span class=o>=</span> <span class=no>File</span><span class=o>.</span><span class=n>new</span> <span class=n>filename</span>
</span></span><span class=line><span class=cl>          <span class=n>instance</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>attachment_name</span> <span class=o>+</span> <span class=s2>&#34;=&#34;</span><span class=p>,</span> <span class=n>old_attachment_file</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=n>instance</span><span class=o>.</span><span class=n>save</span>
</span></span><span class=line><span class=cl>          <span class=n>old_attachment_file</span><span class=o>.</span><span class=n>close</span>
</span></span><span class=line><span class=cl>          <span class=nb>print</span> <span class=s2>&#34;.&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>end</span>
</span></span><span class=line><span class=cl>      <span class=k>end</span>
</span></span><span class=line><span class=cl>    <span class=k>end</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span> <span class=s2>&#34; [DONE]&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>puts</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>move_images</span> <span class=no>Foo</span><span class=p>,</span> <span class=s1>&#39;image&#39;</span>
</span></span><span class=line><span class=cl>  <span class=n>move_images</span> <span class=no>Bar</span><span class=p>,</span> <span class=s1>&#39;image&#39;</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><p>This script is a slightly modified version of the one by Fernando Marcelo you can see <a href=http://fernandomarcelo.com/2012/05/paperclip-how-to-move-existing-attachments-to-a-new-path/ class=external-link target=_blank rel=noopener>here</a>. I changed it a little to make it more verbose and reusable, but big credits go to him for his original work.</p><p>Running this rake task with <code>rake copy_paperclip_data</code> will copy all the original files from their old location to the new one.</p><p>You will still see the warning messages in your <code>production.log</code> file, because so far Paperclip is not smart enough to check your custom path and understand it is enough to prevent conflicts. This will probably be fixed in future releases of Paperclip gem.</p></div><footer></footer></article></section></div><footer class=footer><section class=container>©
2010 -
2024
metalelf0
·
Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>
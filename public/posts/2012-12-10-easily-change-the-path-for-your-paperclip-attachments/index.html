<!DOCTYPE html>
<html lang="en">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <title>
  Easily change the path for your Paperclip attachments · metalelf0.github.io
</title>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">




<meta name="author" content="metalelf0">
<meta name="description" content="Today after releasing an app to production environment I saw a couple of paperclip warnings like this in my production.log file:


1
2
3
4


[paperclip] Duplicate URL for round_image with 
/system/:attachment/:id/:style/:filename. This
will clash with attachment defined in
PageElements::FranchisingCarouselEntry class


This happens because I defined an attachment with the same name in two different models, and the default strategy Paperclip uses to choose attachment locations could lead to filename clashing.">
<meta name="keywords" content="blog,developer,personal">



  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Easily change the path for your Paperclip attachments">
  <meta name="twitter:description" content="Today after releasing an app to production environment I saw a couple of paperclip warnings like this in my production.log file:
1 2 3 4 [paperclip] Duplicate URL for round_image with /system/:attachment/:id/:style/:filename. This will clash with attachment defined in PageElements::FranchisingCarouselEntry class This happens because I defined an attachment with the same name in two different models, and the default strategy Paperclip uses to choose attachment locations could lead to filename clashing.">

<meta property="og:url" content="http://localhost:1313/posts/2012-12-10-easily-change-the-path-for-your-paperclip-attachments/">
  <meta property="og:site_name" content="metalelf0.github.io">
  <meta property="og:title" content="Easily change the path for your Paperclip attachments">
  <meta property="og:description" content="Today after releasing an app to production environment I saw a couple of paperclip warnings like this in my production.log file:
1 2 3 4 [paperclip] Duplicate URL for round_image with /system/:attachment/:id/:style/:filename. This will clash with attachment defined in PageElements::FranchisingCarouselEntry class This happens because I defined an attachment with the same name in two different models, and the default strategy Paperclip uses to choose attachment locations could lead to filename clashing.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2012-12-10T00:00:00+00:00">
    <meta property="article:modified_time" content="2012-12-10T00:00:00+00:00">
    <meta property="article:tag" content="Rails">
    <meta property="article:tag" content="Ruby">
    <meta property="article:tag" content="Paperclip">




<link rel="canonical" href="http://localhost:1313/posts/2012-12-10-easily-change-the-path-for-your-paperclip-attachments/">


<link rel="preload" href="/fonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>


  
  
  <link rel="stylesheet" href="/css/coder.css" media="screen">






  
    
    
    <link rel="stylesheet" href="/css/coder-dark.css" media="screen">
  



 




<link rel="icon" type="image/svg+xml" href="/img/favicon.svg" sizes="any">
<link rel="icon" type="image/png" href="/img/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/img/favicon-16x16.png" sizes="16x16">

<link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">









</head>






<body class="preload-transitions colorscheme-auto">
  
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


  <main class="wrapper">
    <nav class="navigation">
  <section class="container">
    
    <a class="navigation-title" href="http://localhost:1313/">
      metalelf0.github.io
    </a>
    
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa-solid fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link " href="/posts/">Blog</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/about/">About</a>
            </li>
          
        
        
      </ul>
    
  </section>
</nav>


    <div class="content">
      
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="http://localhost:1313/posts/2012-12-10-easily-change-the-path-for-your-paperclip-attachments/">
              Easily change the path for your Paperclip attachments
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa-solid fa-calendar" aria-hidden="true"></i>
              <time datetime="2012-12-10T00:00:00Z">
                December 10, 2012
              </time>
            </span>
            <span class="reading-time">
              <i class="fa-solid fa-clock" aria-hidden="true"></i>
              2-minute read
            </span>
          </div>
          
          <div class="categories">
  <i class="fa-solid fa-folder" aria-hidden="true"></i>
    <a href="/categories/rails/">Rails</a></div>

          <div class="tags">
  <i class="fa-solid fa-tag" aria-hidden="true"></i>
    <span class="tag">
      <a href="/tags/rails/">Rails</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="/tags/ruby/">Ruby</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="/tags/paperclip/">Paperclip</a>
    </span></div>

        </div>
      </header>

      <div class="post-content">
        
        <p>Today after releasing an app to production environment I saw a couple of <a href="https://github.com/thoughtbot/paperclip"  class="external-link" target="_blank" rel="noopener">paperclip</a> warnings like this in my production.log file:</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-txt" data-lang="txt"><span style="display:flex;"><span>[paperclip] Duplicate URL for round_image with 
</span></span><span style="display:flex;"><span>/system/:attachment/:id/:style/:filename. This
</span></span><span style="display:flex;"><span>will clash with attachment defined in
</span></span><span style="display:flex;"><span>PageElements::FranchisingCarouselEntry class
</span></span></code></pre></td></tr></table>
</div>
</div><p>This happens because I defined an attachment with the same name in two different models, and the default strategy Paperclip uses to choose attachment locations could lead to filename clashing.</p>
<p>Here is a more detailed example:</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> Foo
</span></span><span style="display:flex;"><span>  has_attached_file <span style="color:#0ff;font-weight:bold">:image</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> Bar
</span></span><span style="display:flex;"><span>  has_attached_file <span style="color:#0ff;font-weight:bold">:image</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">end</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The default strategy Paperclip uses to store attachments relies on this path: <code>/system/:attachment/:id/:style/:filename</code>.</p>
<p>So, considering our example, if we uploaded two files called <code>image.png</code> for the first <code>Foo</code> instance and the first <code>Bar</code> instance, they would have the same path, <code>/system/image/1/original/image.png</code>.</p>
<p>The solution is quite easy; if we add the following line to our <code>config/environment.rb</code> file, Paperclip will add an extra directory level to separate files across different models:</p>
<pre><code>Paperclip::Attachment.default_options[:url] = &quot;/system/:class/:attachment/:id/:style/:filename&quot;
</code></pre>
<p>From now on Paperclip will search for files in the <code>system/foo/image/1/original/image.png</code> and <code>system/bar/image/1/original/image.png</code> locations. But we still need to move our previously uploaded files to the new path. We can do this with this rake task:</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>desc <span style="color:#0ff;font-weight:bold">&#34;Copy paperclip data&#34;</span>
</span></span><span style="display:flex;"><span>task <span style="color:#0ff;font-weight:bold">:copy_paperclip_data</span> =&gt; <span style="color:#0ff;font-weight:bold">:environment</span> <span style="color:#fff;font-weight:bold">do</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">def</span> move_images klass, attachment_name
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span> <span style="color:#0ff;font-weight:bold">&#34;Moving </span><span style="color:#0ff;font-weight:bold">#{</span>attachment_name.pluralize<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold"> for </span><span style="color:#0ff;font-weight:bold">#{</span>klass<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">: &#34;</span>
</span></span><span style="display:flex;"><span>    instances = klass.find <span style="color:#0ff;font-weight:bold">:all</span>
</span></span><span style="display:flex;"><span>    instances.each <span style="color:#fff;font-weight:bold">do</span> |instance|
</span></span><span style="display:flex;"><span>      file_name_method = attachment_name + <span style="color:#0ff;font-weight:bold">&#34;_file_name&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#fff;font-weight:bold">unless</span> instance.send(file_name_method).blank?
</span></span><span style="display:flex;"><span>        filename = Rails.root.join(<span style="color:#0ff;font-weight:bold">&#39;public&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;system&#39;</span>, attachment_name.pluralize, 
</span></span><span style="display:flex;"><span>          instance.id.to_s, <span style="color:#0ff;font-weight:bold">&#39;original&#39;</span>, instance.send(file_name_method))
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> File.exists? filename
</span></span><span style="display:flex;"><span>          old_attachment_file = File.new filename
</span></span><span style="display:flex;"><span>          instance.send(attachment_name + <span style="color:#0ff;font-weight:bold">&#34;=&#34;</span>, old_attachment_file)
</span></span><span style="display:flex;"><span>          instance.save
</span></span><span style="display:flex;"><span>          old_attachment_file.close
</span></span><span style="display:flex;"><span>          <span style="color:#fff;font-weight:bold">print</span> <span style="color:#0ff;font-weight:bold">&#34;.&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span>      <span style="color:#fff;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span> <span style="color:#0ff;font-weight:bold">&#34; [DONE]&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">puts</span>
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  move_images Foo, <span style="color:#0ff;font-weight:bold">&#39;image&#39;</span>
</span></span><span style="display:flex;"><span>  move_images Bar, <span style="color:#0ff;font-weight:bold">&#39;image&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">end</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This script is a slightly modified version of the one by Fernando Marcelo you can see <a href="http://fernandomarcelo.com/2012/05/paperclip-how-to-move-existing-attachments-to-a-new-path/"  class="external-link" target="_blank" rel="noopener">here</a>. I changed it a little to make it more verbose and reusable, but big credits go to him for his original work.</p>
<p>Running this rake task with <code>rake copy_paperclip_data</code> will copy all the original files from their old location to the new one.</p>
<p>You will still see the warning messages in your <code>production.log</code> file, because so far Paperclip is not smart enough to check your custom path and understand it is enough to prevent conflicts. This will probably be fixed in future releases of Paperclip gem.</p>

      </div>


      <footer>
        


        
        
        
        
        
        
        
      </footer>
    </article>

    
  </section>

    </div>

    <footer class="footer">
  <section class="container">
    ©
    
      2010 -
    
    2024
     metalelf0 
    ·
    
    Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/" target="_blank" rel="noopener">Coder</a>.
    
  </section>
</footer>

  </main>

  

  
  
  <script src="/js/coder.js"></script>
  

  

  


  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
</body>

</html>

<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Fluentd usage example with bash and ruby</title>
	
	<meta name="author" content="Andrea Schiavini">

	<!-- Enable responsive viewport -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

	<!-- Le styles -->
	<link href="/assets/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="/assets/resources/font-awesome/css/font-awesome.min.css" rel="stylesheet">
	<link href="/assets/resources/syntax/syntax.css" rel="stylesheet">
	<link href="/assets/css/style.css" rel="stylesheet">

	<!-- Le fav and touch icons -->
	<!-- Update these with your own images
	<link rel="shortcut icon" href="images/favicon.ico">
	<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
	-->

	<link rel="alternate" type="application/rss+xml" title="" href="/feed.xml">
</head>

<body>
	<nav class="navbar navbar-default visible-xs" role="navigation">
		<!-- Brand and toggle get grouped for better mobile display -->
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
			<a type="button" class="navbar-toggle nav-link" href="http://github.com/metalelf0">
				<i class="fa fa-github"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="http://twitter.com/metalelf0">
				<i class="fa fa-twitter"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="mailto:metalelf0@gmail.com">
				<i class="fa fa-envelope"></i>
			</a>
			
			<a class="navbar-brand" href="/">
				<img src="http://www.gravatar.com/avatar/e147a07bdeb1567782210bda7c9294f9?s=35" class="img-circle" />
				metalelf0 blog
			</a>
		</div>

		<!-- Collect the nav links, forms, and other content for toggling -->
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li class="active"><a href="/">Home</a></li>
				<li><a href="/categories.html">Categories</a></li>
				<li><a href="/tags.html">Tags</a></li>
			</ul>
		</div><!-- /.navbar-collapse -->
	</nav>

	<!-- nav-menu-dropdown -->
	<div class="btn-group hidden-xs" id="nav-menu">
		<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
			<i class="fa fa-bars"></i>
		</button>
		<ul class="dropdown-menu" role="menu">
			<li><a href="/"><i class="fa fa-home"></i>Home</a></li>
			<li><a href="/categories.html"><i class="fa fa-folder"></i>Categories</a></li>
			<li><a href="/tags.html"><i class="fa fa-tags"></i>Tags</a></li>
			<li class="divider"></li>
			<li><a href="#"><i class="fa fa-arrow-up"></i>Top of Page</a></li>
		</ul>
	</div>

	<div class="col-sm-3 sidebar hidden-xs" style="">
		<!-- sidebar.html -->
<header class="sidebar-header" role="banner">
	<a href="/">
		<img src="http://www.gravatar.com/avatar/e147a07bdeb1567782210bda7c9294f9?s=150" class="img-circle" />
	</a>
	<h3 class="title">
        <a href="/">metalelf0 blog</a>
    </h3>
</header>


<div id="bio" class="text-center">
	Andrea Schiavini is a Milan based ruby developer
</div>


<div id="contact-list" class="text-center">
	<ul class="list-unstyled list-inline">
		
		<li>
			<a class="btn btn-default btn-sm" href="https://github.com/metalelf0">
				<i class="fa fa-github-alt fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://twitter.com/metalelf0">
				<i class="fa fa-twitter fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="mailto:metalelf0@gmail.com">
				<i class="fa fa-envelope fa-lg"></i>
			</a>
		</li>
		
	</ul>
	<ul id="contact-list-secondary" class="list-unstyled list-inline">
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://linkedin.com/in/andrea-schiavini-a977183">
				<i class="fa fa-linkedin fa-lg"></i>
			</a>
		</li>
		
		<li>
			<a class="btn btn-default btn-sm" href="/feed.xml">
				<i class="fa fa-rss fa-lg"></i>
			</a>
		</li>
	</ul>
</div>
<!-- sidebar.html end -->

	</div>

	<div class="col-sm-9 col-sm-offset-3">
		<div class="page-header">
  <h1>Fluentd usage example with bash and ruby <small>Json logging for everyone</small></h1>
</div>
	
<article>

	<div class="col-sm-10">
	 <span class="post-date">
	   
	   August 
	   9th,
	   
	   2013
	 </span>
	  <div class="article_body">
	  <p><img class="fluentd-example" src="https://raw.github.com/fluent/website/master/logos/fluentd2.png" alt="fluentd-logo" /></p>

<p><a href="http://fluentd.org/">Fluentd</a> is an open source tool to collect events and
logs. Its architecture allows to easily collect logs from different input
sources and redirect them to different output sinks. Some input examples are
HTTP, syslog, or apache logs, and some output sinks are files, mail, and
databases (both RDBMS and NoSQL ones). Also, it allows to parse logs and to
extract only the significative parts from each of them; saving this
structured information on a DB allows much easier log searching and analysis.</p>

<p><img class="fluentd-example" src="http://docs.fluentd.org/images/apache-to-mongodb.png" alt="fluentd-example" /></p>

<p>The fluentd architecture can be extended with ruby plugins to support input
sources and output destinations; for the scope of this example, we will use:</p>

<ul>
  <li><a href="https://github.com/fluent/fluent-plugin-mongo">MongoDB plugin for Fluent event collector</a>;</li>
  <li><a href="https://github.com/fluent/fluent-logger-ruby">fluent-logger rubygem</a>;</li>
  <li>the built-in tcp input and stdout output.</li>
</ul>

<h3 id="installing-fluentd-server">Installing fluentd server</h3>

<p>The first thing to do is installing the fluentd server. You can easily do this
via rubygems (beware it requires at least ruby 1.9.2):</p>

<pre><code>$ gem install fluentd
</code></pre>

<p>When you’re done you can create a setup file:</p>

<pre><code>$ fluentd -s ~/.fluentd
</code></pre>

<p>This will create the file <code>~/.fluentd/fluent.conf</code> and setup the <code>~/.fluent/plugins</code> folder.</p>

<h3 id="the-fluentdconf-file">The fluentd.conf file</h3>

<p>Edit the configuration file with your favourite editor (which is vim, of
course), and make it look like this:</p>

<noscript><pre>400: Invalid request
</pre></noscript>
<script src="https://gist.github.com/6193677.js"> </script>

<p>You can see it’s made of three parts:</p>

<ol>
  <li>The first one is the default HTTP source input. It listens for JSON messages
on port <code>24224</code>.</li>
  <li>The second one is the default standard output. The <code>match fluentd.test.**</code>
line tells fluentd to forward all messages matching the given pattern to the
chosen standard output.</li>
  <li>The third block is the MongoDB output. It requires the MongoDB plugin cited
above to be installed, but we’ll talk about this later.</li>
</ol>

<p>Let’s start the server and keep it running in foreground, to easily see
incoming messages:</p>

<pre><code>$ fluentd -c ~/.fluent/fluent.conf
</code></pre>

<h3 id="logging-from-bash-to-stdout">Logging from bash to STDOUT</h3>

<p>Now, let’s prepare a sample bash script to log things to <code>fluentd</code>. Open
another terminal, create a bash script and paste the following content:</p>

<noscript><pre>400: Invalid request
</pre></noscript>
<script src="https://gist.github.com/6194294.js"> </script>

<p>As you can see I created a wrapper function to make it easier to redirect logs
to <code>fluentd</code>. Save the file, make it executable and run it. You should see output
like this in your server:</p>

<pre><code>2013-08-09 17:01:06 +0200 [trace]: plugin/in_forward.rb:150:initialize: accepted fluent socket object_id=70144024060720
2013-08-09 17:01:06 +0200 fluentd.test.log: {"project":"Library","script_name":"Reload books","message":"Started"}
2013-08-09 17:01:06 +0200 [trace]: plugin/in_forward.rb:191:on_close: closed fluent socket object_id=70144024060720
</code></pre>

<p>This is telling us that <code>fluentd</code> is accepting input from the <code>fluent-cat</code> command
and it is redirecting it to standard output, according to the first rule.</p>

<h3 id="logging-from-bash-to-mongodb">Logging from bash to MongoDB</h3>

<p>To go on in our test, we need to install MongoDB. Use the best way depending on
your system (I used <code>homebrew</code> on my mac), run it and connect to its console via
the <code>mongo</code> command.</p>

<p>Now, in the previous bash script, change the target of <code>fluent-cat</code> from
<code>fluentd.test.log</code> to <code>mongo.log</code>. Save it, run it again, and type this in your
MongoDB console:</p>

<pre><code>$ db.test.find()
</code></pre>

<p>This time you should see an entry in the <code>test</code> collection:</p>

<pre><code>{ "_id" : ObjectId("5204dfee9f60b167da000004"), "project" : "Library", "script_name" : "Reload books", "message" : "Started", "time" : ISODate("2013-08-09T12:26:22Z") }
</code></pre>

<h3 id="logging-from-bash-to-mongodb-1">Logging from bash to MongoDB</h3>

<p>Let’s see how to achieve the same result in a ruby script. Install the fluent-logger
rubygem with</p>

<pre><code>$ gem install fluent-logger
</code></pre>

<p>Then create a ruby script with the following content:</p>

<noscript><pre>400: Invalid request
</pre></noscript>
<script src="https://gist.github.com/6194505.js"> </script>

<p>Run it, rerun the query in the MongoDB console, and a new entry should be present.</p>

<pre><code>{ "_id" : ObjectId("5204dfee9f60b167da000005"), "project" : "Library", "script_name" : "Reload books", "message" : "Completed", "time" : ISODate("2013-08-09T12:46:32Z") }
</code></pre>

<h3 id="final-considerations">Final considerations</h3>

<p>The ease of use of <code>fluentd</code> allows to quickly setup a centralized log system in
just a few hours. You could use any tool you want to browse data in the MongoDB
database. You can make elaborate statistics, build charts, and do everything you
want with it. According to the <code>fluentd</code> website, its simple architecture allows
it to run with very good performances:</p>

<pre><code>"Fluentd’s performance has been proven in the field: its largest user
currently collects logs from 5000+ servers, 5 TB of daily data, handling
50,000 msgs/sec at peak time."
</code></pre>

<p>So, I hope this post helped you to understand what this tool is about. I
suggest you to check out the <a href="http://docs.fluentd.org/articles/quickstart">fluentd
documentation</a> to know more, it’s
really complete and clear. If you found this post useful, feel free to drop me
a line :)</p>


	  </div>

		
		<ul class="tag_box list-unstyled list-inline">
		  <li><i class="fa fa-folder-open"></i></li>
		  
		  
			 
				<li><a href="/categories.html#tools-ref">
					tools <span>(2)</span>
					
				</a></li>
			
		  
		</ul>
		  

		
		<ul class="list-inline">
		  <li><i class="fa fa-tags"></i></li>
		  
		  
			 
				<li>
					<a href="/tags.html#ruby-ref">
					ruby <span>(14)</span>
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#logging-ref">
					logging <span>(1)</span>
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#json-ref">
					json <span>(1)</span>
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#fluentd-ref">
					fluentd <span>(1)</span>
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#bash-ref">
					bash <span>(1)</span>
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#shell-ref">
					shell <span>(1)</span>
					
					</a>
				</li>
			
		  
		  
		</ul>
		  

		<hr>

		<div>
      <section class="share col-sm-6">
        <h4 class="section-title">Share Post</h4>
        <a class="btn btn-default btn-sm twitter" href="http://twitter.com/share?text=Fluentd usage example with bash and ruby&via=metalelf0"
           onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
          <i class="fa fa-twitter fa-lg"></i>
          Twitter
        </a>
        <a class="btn btn-default btn-sm facebook" href="https://www.facebook.com/sharer/sharer.php"
           onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
          <i class="fa fa-facebook fa-lg"></i>
          Facebook
        </a>
        <a class="btn btn-default btn-sm gplus"
           onclick="window.open('https://plus.google.com/share?url='+window.location.href, 'google-plus-share', 'width=490,height=530');return false;">
          <i class="fa fa-google-plus fa-lg"></i>
          Google+
        </a>
      </section>

      <section class="col-sm-6 author">
        <img src="http://www.gravatar.com/avatar/e147a07bdeb1567782210bda7c9294f9" class="img-rounded author-image" />
        <h4 class="section-title author-name">Andrea Schiavini</h4>
        <p class="author-bio">Andrea Schiavini is a Milan based ruby developer</p>
      </section>
    </div>

    <div class="clearfix"></div>

		<ul class="pager">
		  
		  <li class="previous"><a href="/rails/2012/12/10/easily-change-the-path-for-your-paperclip-attachments.html" title="Easily change the path for your Paperclip attachments">&larr; Previous</a></li>
		  
		  
		  <li class="next"><a href="/rails/2013/12/23/null-objects-in-rails.html" title="Null objects in Rails">Next &rarr;</a></li>
		  
		</ul>

		<hr>
	</div>
	
	<div class="col-sm-2 sidebar-2">
	
	</div>
</article>
<div class="clearfix"></div>



    
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'metalelf0-github-io';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>





		<footer>
			<hr/>
			<p>
				&copy; 2016 Andrea Schiavini with <a href="http://jekyllrb.com/">Jekyll</a>. Theme: <a href="https://github.com/dbtek/dbyll">dbyll</a> by dbtek.
			</p>
		</footer>
	</div>

	<script type="text/javascript" src="/assets/resources/jquery/jquery.min.js"></script>
	<script type="text/javascript" src="/assets/resources/bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="/assets/js/app.js"></script>
</body>
</html>



<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'ga-123-12', 'auto');
  ga('send', 'pageview');
</script>


<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Mocked - a minitest pattern</title>
	
	<meta name="author" content="Andrea Schiavini">

	<!-- Enable responsive viewport -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

	<!-- Le styles -->
	<link href="/assets/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="/assets/resources/font-awesome/css/font-awesome.min.css" rel="stylesheet">
	<link href="/assets/resources/syntax/syntax.css" rel="stylesheet">
	<link href="/assets/css/style.css" rel="stylesheet">

	<!-- Le fav and touch icons -->
	<!-- Update these with your own images
	<link rel="shortcut icon" href="images/favicon.ico">
	<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
	-->

	<link rel="alternate" type="application/rss+xml" title="" href="/feed.xml">
</head>

<body>
	<nav class="navbar navbar-default visible-xs" role="navigation">
		<!-- Brand and toggle get grouped for better mobile display -->
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
			<a type="button" class="navbar-toggle nav-link" href="http://github.com/metalelf0">
				<i class="fa fa-github"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="http://twitter.com/metalelf0">
				<i class="fa fa-twitter"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="mailto:metalelf0@gmail.com">
				<i class="fa fa-envelope"></i>
			</a>
			
			<a class="navbar-brand" href="/">
				<img src="http://www.gravatar.com/avatar/e147a07bdeb1567782210bda7c9294f9?s=35" class="img-circle" />
				metalelf0 blog
			</a>
		</div>

		<!-- Collect the nav links, forms, and other content for toggling -->
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li class="active"><a href="/">Home</a></li>
				<li><a href="/categories.html">Categories</a></li>
				<li><a href="/tags.html">Tags</a></li>
			</ul>
		</div><!-- /.navbar-collapse -->
	</nav>

	<!-- nav-menu-dropdown -->
	<div class="btn-group hidden-xs" id="nav-menu">
		<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
			<i class="fa fa-bars"></i>
		</button>
		<ul class="dropdown-menu" role="menu">
			<li><a href="/"><i class="fa fa-home"></i>Home</a></li>
			<li><a href="/categories.html"><i class="fa fa-folder"></i>Categories</a></li>
			<li><a href="/tags.html"><i class="fa fa-tags"></i>Tags</a></li>
			<li class="divider"></li>
			<li><a href="#"><i class="fa fa-arrow-up"></i>Top of Page</a></li>
		</ul>
	</div>

	<div class="col-sm-3 sidebar hidden-xs" style="">
		<!-- sidebar.html -->
<header class="sidebar-header" role="banner">
	<a href="/">
		<img src="http://www.gravatar.com/avatar/e147a07bdeb1567782210bda7c9294f9?s=150" class="img-circle" />
	</a>
	<h3 class="title">
        <a href="/">metalelf0 blog</a>
    </h3>
</header>


<div id="bio" class="text-center">
	Andrea Schiavini is a Milan based ruby developer
</div>


<div id="contact-list" class="text-center">
	<ul class="list-unstyled list-inline">
		
		<li>
			<a class="btn btn-default btn-sm" href="https://github.com/metalelf0">
				<i class="fa fa-github-alt fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://twitter.com/metalelf0">
				<i class="fa fa-twitter fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="mailto:metalelf0@gmail.com">
				<i class="fa fa-envelope fa-lg"></i>
			</a>
		</li>
		
	</ul>
	<ul id="contact-list-secondary" class="list-unstyled list-inline">
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://linkedin.com/in/andrea-schiavini-a977183">
				<i class="fa fa-linkedin fa-lg"></i>
			</a>
		</li>
		
		<li>
			<a class="btn btn-default btn-sm" href="/feed.xml">
				<i class="fa fa-rss fa-lg"></i>
			</a>
		</li>
	</ul>
</div>
<!-- sidebar.html end -->

	</div>

	<div class="col-sm-9 col-sm-offset-3">
		<div class="page-header">
  <h1>Mocked - a minitest pattern <small>mocking stuff has never been so fun!</small></h1>
</div>
	
<article>

	<div class="col-sm-10">
	 <span class="post-date">
	   
	   May 
	   11th,
	   
	   2016
	 </span>
	  <div class="article_body">
	  <h3 id="minitest-is-good-for-mocking-right-well">Minitest is good for mocking, right? Well…</h3>

<p>Minitest is gaining a lot of popularity and can actually be a 100% replacement
for RSpec. It’s a pure ruby testing framework, it’s fast, light weight, and it
supports both a test-unit like syntax and a spec engine with Rspec like syntax.</p>

<p>Still, when it comes to mocking, it can be a little painful. You have to
initialize mocks and verify them manually after running the code under test.</p>

<!--more-->

<p>A typical unit test with mocks looks something like this:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">test</span> <span class="s1">&#39;a pause can be completed&#39;</span> <span class="k">do</span>
  <span class="n">datetime_service</span> <span class="o">=</span> <span class="no">MiniTest</span><span class="o">::</span><span class="no">Mock</span><span class="o">.</span><span class="n">new</span>
  <span class="n">pause</span>            <span class="o">=</span> <span class="no">MiniTest</span><span class="o">::</span><span class="no">Mock</span><span class="o">.</span><span class="n">new</span>
  <span class="n">success</span>          <span class="o">=</span> <span class="no">MiniTest</span><span class="o">::</span><span class="no">Mock</span><span class="o">.</span><span class="n">new</span>
  <span class="n">failure</span>          <span class="o">=</span> <span class="no">MiniTest</span><span class="o">::</span><span class="no">Mock</span><span class="o">.</span><span class="n">new</span>
  <span class="n">now</span> <span class="o">=</span> <span class="no">DateTime</span><span class="o">.</span><span class="n">now</span>
  <span class="n">datetime_service</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="ss">:datetime_now</span><span class="p">,</span> <span class="n">now</span><span class="p">)</span>
  <span class="n">pause</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="ss">:completed_at</span><span class="p">,</span> <span class="kp">nil</span><span class="p">)</span>
  <span class="n">pause</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="ss">:update_attributes</span><span class="p">,</span> <span class="kp">true</span><span class="p">,</span> <span class="o">[</span><span class="ss">completed_at</span><span class="p">:</span> <span class="n">now</span><span class="o">]</span><span class="p">)</span>
  <span class="n">success</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="ss">:call</span><span class="p">,</span> <span class="kp">true</span><span class="p">,</span> <span class="o">[</span><span class="s2">&quot;Pause completed&quot;</span><span class="p">,</span> <span class="n">pause</span><span class="o">]</span><span class="p">)</span>
  <span class="no">UseCases</span><span class="o">::</span><span class="no">Pauses</span><span class="o">::</span><span class="no">Complete</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">pause</span><span class="p">,</span> <span class="n">datetime_service</span><span class="p">,</span> <span class="n">success</span><span class="p">,</span> <span class="n">failure</span><span class="p">)</span>
  <span class="n">datetime_service</span><span class="o">.</span><span class="n">verify</span>
  <span class="n">failure</span><span class="o">.</span><span class="n">verify</span>
  <span class="n">success</span><span class="o">.</span><span class="n">verify</span>
  <span class="n">pause</span><span class="o">.</span><span class="n">verify</span>
<span class="k">end</span></code></pre></figure>

<p>What I don’t like in the code above is the verbosity in the setup (and
verification) of mock objects. I’m relying quite heavily on mocks, as I don’t
want to pass real objects to my unit tests, and this kind of repetition is not
good.</p>

<p>Also I want to have a way to distinguish mock objects from “real” objects.
This could help seeing if there is too much “real” stuff inside the test, or if
I’m correctly mocking all the dependencies and collaborators of the method under
test.</p>

<p>What I came up with is <code>Mocked</code>, a small module to streamline these operations.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># test/utils/mocked.rb</span>
<span class="k">module</span> <span class="nn">Mocked</span>
  <span class="k">def</span> <span class="nf">add_mocks</span><span class="p">(</span><span class="o">*</span><span class="n">names</span><span class="p">)</span>
    <span class="n">names</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="nb">name</span><span class="o">|</span> <span class="n">add_mock</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">add_mock</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
    <span class="vi">@mocks</span><span class="o">[</span><span class="nb">name</span><span class="o">]</span> <span class="o">=</span> <span class="no">MiniTest</span><span class="o">::</span><span class="no">Mock</span><span class="o">.</span><span class="n">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">mocked</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
    <span class="vi">@mocks</span><span class="o">[</span><span class="nb">name</span><span class="o">]</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">verify_mocks</span>
    <span class="vi">@mocks</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">_</span><span class="p">,</span> <span class="n">mock</span><span class="o">|</span>
      <span class="n">mock</span><span class="o">.</span><span class="n">verify</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">setup_mocks</span>
    <span class="vi">@mocks</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># test/test_helper.rb</span>

<span class="c1">#...</span>
<span class="nb">require</span> <span class="s1">&#39;utils/mocked&#39;</span>
<span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="kp">include</span> <span class="no">Mocked</span>
  <span class="n">setup</span> <span class="ss">:setup_mocks</span>
  <span class="n">teardown</span> <span class="ss">:verify_mocks</span>
<span class="k">end</span></code></pre></figure>

<p>We are just keeping an hash of mock objects, and verifying them on teardown of
the test; we are also giving a <code>mocked(mock_name)</code> accessor to retrieve mock
objects.</p>

<p>With this we can rewrite the test above like this:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">test</span> <span class="s1">&#39;a pause can be completed&#39;</span> <span class="k">do</span>
  <span class="n">add_mocks</span><span class="p">(</span><span class="ss">:datetime_service</span><span class="p">,</span> <span class="ss">:pause</span><span class="p">,</span> <span class="ss">:success</span><span class="p">,</span> <span class="ss">:failure</span><span class="p">)</span>
  <span class="n">now</span> <span class="o">=</span> <span class="no">DateTime</span><span class="o">.</span><span class="n">now</span>
  <span class="n">mocked</span><span class="p">(</span><span class="ss">:datetime_service</span><span class="p">)</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="ss">:datetime_now</span><span class="p">,</span> <span class="n">now</span><span class="p">)</span>
  <span class="n">mocked</span><span class="p">(</span><span class="ss">:pause</span><span class="p">)</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="ss">:completed_at</span><span class="p">,</span> <span class="kp">nil</span><span class="p">)</span>
  <span class="n">mocked</span><span class="p">(</span><span class="ss">:pause</span><span class="p">)</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="ss">:update_attributes</span><span class="p">,</span> <span class="kp">true</span><span class="p">,</span> <span class="o">[</span><span class="ss">completed_at</span><span class="p">:</span> <span class="n">now</span><span class="o">]</span><span class="p">)</span>
  <span class="n">mocked</span><span class="p">(</span><span class="ss">:success</span><span class="p">)</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="ss">:call</span><span class="p">,</span> <span class="kp">true</span><span class="p">,</span> <span class="o">[</span><span class="s2">&quot;Pause completed&quot;</span><span class="p">,</span> <span class="n">mocked</span><span class="p">(</span><span class="ss">:pause</span><span class="p">)</span><span class="o">]</span><span class="p">)</span>
  <span class="no">UseCases</span><span class="o">::</span><span class="no">Pauses</span><span class="o">::</span><span class="no">Complete</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
    <span class="n">mocked</span><span class="p">(</span><span class="ss">:pause</span><span class="p">),</span>
    <span class="n">mocked</span><span class="p">(</span><span class="ss">:datetime_service</span><span class="p">),</span>
    <span class="n">mocked</span><span class="p">(</span><span class="ss">:success</span><span class="p">),</span>
    <span class="n">mocked</span><span class="p">(</span><span class="ss">:failure</span><span class="p">)</span>
  <span class="p">)</span>
<span class="k">end</span></code></pre></figure>

<p>The code looks better IMHO, and I like that if I decided - i.e. - to replace
the <code>pause</code> mock with a real object it would read like:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">test</span> <span class="s1">&#39;a pause can be completed&#39;</span> <span class="k">do</span>
  <span class="n">add_mocks</span><span class="p">(</span><span class="ss">:datetime_service</span><span class="p">,</span> <span class="ss">:success</span><span class="p">,</span> <span class="ss">:failure</span><span class="p">)</span>
  <span class="n">now</span> <span class="o">=</span> <span class="no">DateTime</span><span class="o">.</span><span class="n">now</span>
  <span class="n">mocked</span><span class="p">(</span><span class="ss">:datetime_service</span><span class="p">)</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="ss">:datetime_now</span><span class="p">,</span> <span class="n">now</span><span class="p">)</span>
  <span class="n">pause</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:pause</span><span class="p">,</span> <span class="ss">completed_at</span><span class="p">:</span> <span class="kp">nil</span><span class="p">)</span>
  <span class="n">mocked</span><span class="p">(</span><span class="ss">:success</span><span class="p">)</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="ss">:call</span><span class="p">,</span> <span class="kp">true</span><span class="p">,</span> <span class="o">[</span><span class="s2">&quot;Pause completed&quot;</span><span class="p">,</span> <span class="n">pause</span><span class="o">]</span><span class="p">)</span>
  <span class="no">UseCases</span><span class="o">::</span><span class="no">Pauses</span><span class="o">::</span><span class="no">Complete</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
    <span class="n">pause</span><span class="p">,</span>
    <span class="n">mocked</span><span class="p">(</span><span class="ss">:datetime_service</span><span class="p">),</span>
    <span class="n">mocked</span><span class="p">(</span><span class="ss">:success</span><span class="p">),</span>
    <span class="n">mocked</span><span class="p">(</span><span class="ss">:failure</span><span class="p">)</span>
  <span class="p">)</span>
  <span class="n">assert_equal</span> <span class="n">now</span><span class="p">,</span> <span class="n">pause</span><span class="o">.</span><span class="n">completed_at</span>
<span class="k">end</span></code></pre></figure>

<p>Here you can clearly see at a first glance that the only real object is <code>pause</code>,
whereas other objects are all mocked. It also really helps when refactoring
tests.</p>

<p>What do you think about this? Would you like to be built into a gem, do you have
any suggestions or criticism on this? Let me know and have a great day!</p>

	  </div>

		
		<ul class="tag_box list-unstyled list-inline">
		  <li><i class="fa fa-folder-open"></i></li>
		  
		  
			 
				<li><a href="/categories.html#rails-ref">
					rails <span>(10)</span>
					
				</a></li>
			
		  
		</ul>
		  

		
		<ul class="list-inline">
		  <li><i class="fa fa-tags"></i></li>
		  
		  
			 
				<li>
					<a href="/tags.html#rails-ref">
					rails <span>(13)</span>
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#ruby-ref">
					ruby <span>(14)</span>
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#oo-ref">
					oo <span>(3)</span>
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#test-ref">
					test <span>(2)</span>
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#minitest-ref">
					minitest <span>(1)</span>
					
					</a>
				</li>
			
		  
		  
		</ul>
		  

		<hr>

		<div>
      <section class="share col-sm-6">
        <h4 class="section-title">Share Post</h4>
        <a class="btn btn-default btn-sm twitter" href="http://twitter.com/share?text=Mocked - a minitest pattern&via=metalelf0"
           onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
          <i class="fa fa-twitter fa-lg"></i>
          Twitter
        </a>
        <a class="btn btn-default btn-sm facebook" href="https://www.facebook.com/sharer/sharer.php"
           onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
          <i class="fa fa-facebook fa-lg"></i>
          Facebook
        </a>
        <a class="btn btn-default btn-sm gplus"
           onclick="window.open('https://plus.google.com/share?url='+window.location.href, 'google-plus-share', 'width=490,height=530');return false;">
          <i class="fa fa-google-plus fa-lg"></i>
          Google+
        </a>
      </section>

      <section class="col-sm-6 author">
        <img src="http://www.gravatar.com/avatar/e147a07bdeb1567782210bda7c9294f9" class="img-rounded author-image" />
        <h4 class="section-title author-name">Andrea Schiavini</h4>
        <p class="author-bio">Andrea Schiavini is a Milan based ruby developer</p>
      </section>
    </div>

    <div class="clearfix"></div>

		<ul class="pager">
		  
		  <li class="previous"><a href="/rails/2016/05/02/command-pattern.html" title="Command pattern in ruby and rails">&larr; Previous</a></li>
		  
		  
		  <li class="next"><a href="/vim/2016/07/29/vim-sort-ruby-methods-by-name.html" title="Vim - sort ruby methods by name">Next &rarr;</a></li>
		  
		</ul>

		<hr>
	</div>
	
	<div class="col-sm-2 sidebar-2">
	
	</div>
</article>
<div class="clearfix"></div>



    
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'metalelf0-github-io';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>





		<footer>
			<hr/>
			<p>
				&copy; 2016 Andrea Schiavini with <a href="http://jekyllrb.com/">Jekyll</a>. Theme: <a href="https://github.com/dbtek/dbyll">dbyll</a> by dbtek.
			</p>
		</footer>
	</div>

	<script type="text/javascript" src="/assets/resources/jquery/jquery.min.js"></script>
	<script type="text/javascript" src="/assets/resources/bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="/assets/js/app.js"></script>
</body>
</html>



<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'ga-123-12', 'auto');
  ga('send', 'pageview');
</script>


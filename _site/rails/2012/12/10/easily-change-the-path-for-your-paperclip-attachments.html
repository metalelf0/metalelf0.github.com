<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Easily change the path for your Paperclip attachments</title>
	
	<meta name="author" content="Andrea Schiavini">

	<!-- Enable responsive viewport -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

	<!-- Le styles -->
	<link href="/assets/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="/assets/resources/font-awesome/css/font-awesome.min.css" rel="stylesheet">
	<link href="/assets/resources/syntax/syntax.css" rel="stylesheet">
	<link href="/assets/css/style.css" rel="stylesheet">

	<!-- Le fav and touch icons -->
	<!-- Update these with your own images
	<link rel="shortcut icon" href="images/favicon.ico">
	<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
	-->

	<link rel="alternate" type="application/rss+xml" title="" href="/feed.xml">
</head>

<body>
	<nav class="navbar navbar-default visible-xs" role="navigation">
		<!-- Brand and toggle get grouped for better mobile display -->
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
			<a type="button" class="navbar-toggle nav-link" href="http://github.com/metalelf0">
				<i class="fa fa-github"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="http://twitter.com/metalelf0">
				<i class="fa fa-twitter"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="mailto:metalelf0@gmail.com">
				<i class="fa fa-envelope"></i>
			</a>
			
			<a class="navbar-brand" href="/">
				<img src="http://www.gravatar.com/avatar/e147a07bdeb1567782210bda7c9294f9?s=35" class="img-circle" />
				metalelf0 blog
			</a>
		</div>

		<!-- Collect the nav links, forms, and other content for toggling -->
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li class="active"><a href="/">Home</a></li>
				<li><a href="/categories.html">Categories</a></li>
				<li><a href="/tags.html">Tags</a></li>
			</ul>
		</div><!-- /.navbar-collapse -->
	</nav>

	<!-- nav-menu-dropdown -->
	<div class="btn-group hidden-xs" id="nav-menu">
		<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
			<i class="fa fa-bars"></i>
		</button>
		<ul class="dropdown-menu" role="menu">
			<li><a href="/"><i class="fa fa-home"></i>Home</a></li>
			<li><a href="/categories.html"><i class="fa fa-folder"></i>Categories</a></li>
			<li><a href="/tags.html"><i class="fa fa-tags"></i>Tags</a></li>
			<li class="divider"></li>
			<li><a href="#"><i class="fa fa-arrow-up"></i>Top of Page</a></li>
		</ul>
	</div>

	<div class="col-sm-3 sidebar hidden-xs" style="">
		<!-- sidebar.html -->
<header class="sidebar-header" role="banner">
	<a href="/">
		<img src="http://www.gravatar.com/avatar/e147a07bdeb1567782210bda7c9294f9?s=150" class="img-circle" />
	</a>
	<h3 class="title">
        <a href="/">metalelf0 blog</a>
    </h3>
</header>


<div id="bio" class="text-center">
	Andrea Schiavini is a Milan based ruby developer
</div>


<div id="contact-list" class="text-center">
	<ul class="list-unstyled list-inline">
		
		<li>
			<a class="btn btn-default btn-sm" href="https://github.com/metalelf0">
				<i class="fa fa-github-alt fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://twitter.com/metalelf0">
				<i class="fa fa-twitter fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="mailto:metalelf0@gmail.com">
				<i class="fa fa-envelope fa-lg"></i>
			</a>
		</li>
		
	</ul>
	<ul id="contact-list-secondary" class="list-unstyled list-inline">
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://linkedin.com/in/andrea-schiavini-a977183">
				<i class="fa fa-linkedin fa-lg"></i>
			</a>
		</li>
		
		<li>
			<a class="btn btn-default btn-sm" href="/feed.xml">
				<i class="fa fa-rss fa-lg"></i>
			</a>
		</li>
	</ul>
</div>
<!-- sidebar.html end -->

	</div>

	<div class="col-sm-9 col-sm-offset-3">
		<div class="page-header">
  <h1>Easily change the path for your Paperclip attachments <small>And prevent filename clashes</small></h1>
</div>
	
<article>

	<div class="col-sm-10">
	 <span class="post-date">
	   
	   December 
	   10th,
	   
	   2012
	 </span>
	  <div class="article_body">
	  <p>Today after releasing an app to production environment I saw a couple of
<a href="https://github.com/thoughtbot/paperclip">paperclip</a> warnings like this 
in my production.log file:</p>

<pre><code>[paperclip] Duplicate URL for round_image with /system/:attachment/:id/:style/:filename. This will clash with attachment defined in PageElements::FranchisingCarouselEntry class
</code></pre>

<p>This happens because I defined an attachment with the same name in two
different models, and the default strategy Paperclip uses to choose
attachment locations could lead to filename clashing.</p>

<p>Here is a more detailed example:</p>

<pre><code>class Foo
  has_attached_file :image
end

class Bar
  has_attached_file :image
end
</code></pre>

<p>The default strategy Paperclip uses to store attachments relies on this
path: <code>/system/:attachment/:id/:style/:filename</code>.</p>

<p>So, considering our example, if we uploaded two files called <code>image.png</code>
for the first <code>Foo</code> instance and the first <code>Bar</code> instance, they would
have the same path, <code>/system/image/1/original/image.png</code>.</p>

<p>The solution is quite easy; if we add the following line to our
<code>config/environment.rb</code> file, Paperclip will add an extra directory
level to separate files across different models:</p>

<pre><code>Paperclip::Attachment.default_options[:url] = "/system/:class/:attachment/:id/:style/:filename"
</code></pre>

<p>From now on Paperclip will search for files in the
<code>system/foo/image/1/original/image.png</code> and
<code>system/bar/image/1/original/image.png</code> locations. But we still need to
move our previously uploaded files to the new path. We can do this with
this rake task:</p>

<pre><code>desc "Copy paperclip data"
task :copy_paperclip_data =&gt; :environment do

  def move_images klass, attachment_name
    print "Moving #{attachment_name.pluralize} for #{klass}: "
    instances = klass.find :all
    instances.each do |instance|
      file_name_method = attachment_name + "_file_name"
      unless instance.send(file_name_method).blank?
        filename = Rails.root.join('public', 'system', attachment_name.pluralize, instance.id.to_s, 'original', instance.send(file_name_method))
        if File.exists? filename
          old_attachment_file = File.new filename
          instance.send(attachment_name + "=", old_attachment_file)
          instance.save
          old_attachment_file.close
          print "."
        end
      end
    end
    print " [DONE]"
    puts
  end

  move_images Foo, 'image'
  move_images Bar, 'image'

end
</code></pre>

<p>This script is a slightly modified version of the one by Fernando
Marcelo you can see <a href="http://fernandomarcelo.com/2012/05/paperclip-how-to-move-existing-attachments-to-a-new-path/">here</a>.
I changed it a little to make it more verbose and reusable, but big
credits go to him for his original work.</p>

<p>Running this rake task with <code>rake copy_paperclip_data</code> will copy all the
original files from their old location to the new one.</p>

<p>You will still see the warning messages in your <code>production.log</code> file,
because so far Paperclip is not smart enough to check your custom path
and understand it is enough to prevent conflicts. This will probably be
fixed in future releases of Paperclip gem.</p>


	  </div>

		
		<ul class="tag_box list-unstyled list-inline">
		  <li><i class="fa fa-folder-open"></i></li>
		  
		  
			 
				<li><a href="/categories.html#rails-ref">
					rails <span>(10)</span>
					
				</a></li>
			
		  
		</ul>
		  

		
		<ul class="list-inline">
		  <li><i class="fa fa-tags"></i></li>
		  
		  
			 
				<li>
					<a href="/tags.html#rails-ref">
					rails <span>(13)</span>
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#ruby-ref">
					ruby <span>(14)</span>
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#paperclip-ref">
					paperclip <span>(1)</span>
					
					</a>
				</li>
			
		  
		  
		</ul>
		  

		<hr>

		<div>
      <section class="share col-sm-6">
        <h4 class="section-title">Share Post</h4>
        <a class="btn btn-default btn-sm twitter" href="http://twitter.com/share?text=Easily change the path for your Paperclip attachments&via=metalelf0"
           onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
          <i class="fa fa-twitter fa-lg"></i>
          Twitter
        </a>
        <a class="btn btn-default btn-sm facebook" href="https://www.facebook.com/sharer/sharer.php"
           onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
          <i class="fa fa-facebook fa-lg"></i>
          Facebook
        </a>
        <a class="btn btn-default btn-sm gplus"
           onclick="window.open('https://plus.google.com/share?url='+window.location.href, 'google-plus-share', 'width=490,height=530');return false;">
          <i class="fa fa-google-plus fa-lg"></i>
          Google+
        </a>
      </section>

      <section class="col-sm-6 author">
        <img src="http://www.gravatar.com/avatar/e147a07bdeb1567782210bda7c9294f9" class="img-rounded author-image" />
        <h4 class="section-title author-name">Andrea Schiavini</h4>
        <p class="author-bio">Andrea Schiavini is a Milan based ruby developer</p>
      </section>
    </div>

    <div class="clearfix"></div>

		<ul class="pager">
		  
		  <li class="previous"><a href="/vim/2012/07/09/vim-regexp-example.html" title="Vim regexp example: make a variable out of params">&larr; Previous</a></li>
		  
		  
		  <li class="next"><a href="/tools/2013/08/09/fluentd-usage-example-with-bash-and-ruby.html" title="Fluentd usage example with bash and ruby">Next &rarr;</a></li>
		  
		</ul>

		<hr>
	</div>
	
	<div class="col-sm-2 sidebar-2">
	
	</div>
</article>
<div class="clearfix"></div>



    
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'metalelf0-github-io';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>





		<footer>
			<hr/>
			<p>
				&copy; 2016 Andrea Schiavini with <a href="http://jekyllrb.com/">Jekyll</a>. Theme: <a href="https://github.com/dbtek/dbyll">dbyll</a> by dbtek.
			</p>
		</footer>
	</div>

	<script type="text/javascript" src="/assets/resources/jquery/jquery.min.js"></script>
	<script type="text/javascript" src="/assets/resources/bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="/assets/js/app.js"></script>
</body>
</html>



<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'ga-123-12', 'auto');
  ga('send', 'pageview');
</script>

